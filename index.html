<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <!-- è®“ iOS Safari ä»¥å…¨è¢å¹•é–‹å•Ÿ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- ç‹€æ…‹åˆ—æ¨£å¼ï¼Œå¯é¸ default / black / black-translucent -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- åŠ å…¥ä¸»ç•«é¢æ™‚çš„é¡¯ç¤ºåç¨± -->
  <meta name="apple-mobile-web-app-title" content="ç¦®é‡‘ç°¿">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¦®é‡‘ç°¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-3xl mx-auto space-y-6">
    <h1 class="text-3xl font-bold text-center mb-4">ğŸ ç¦®é‡‘ç°¿</h1>

    <!-- è¡¨å–® -->
    <div class="bg-white p-4 rounded-2xl shadow space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <input id="name" type="text" placeholder="ä¾†è³“å§“å" class="w-full p-2 border rounded"/>
        <input id="amount" type="number" placeholder="é‡‘é¡" class="w-full p-2 border rounded"/>
      </div>

      <!-- å¿«é€Ÿé‡‘é¡æŒ‰éˆ• -->
      <div class="flex gap-2 flex-wrap">
        <button class="quick-amount bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">2000</button>
        <button class="quick-amount bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">5000</button>
        <button class="quick-amount bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">6000</button>
        <button class="quick-amount bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">2200</button>
        <button class="quick-amount bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">2600</button>
      </div>

      <!-- æ–°å¢åˆ†é¡ä¸‹æ‹‰é¸å–® -->
      <select id="category" class="w-full p-2 border rounded">
        <option value="æ–°å¨˜è¦ªå‹">æ–°å¨˜è¦ªå‹</option>
        <option value="æ–°éƒè¦ªå‹">æ–°éƒè¦ªå‹</option>
        <option value="ç”·æ–¹çˆ¶æ¯æœ‹å‹">ç”·æ–¹çˆ¶æ¯æœ‹å‹</option>
        <option value="å¥³æ–¹çˆ¶æ¯æœ‹å‹">å¥³æ–¹çˆ¶æ¯æœ‹å‹</option>
      </select>
      
      <!-- å‹¾é¸æ”¶é¤… -->
      <label class="flex items-center gap-2">
        <input type="checkbox" id="receivedCake"/>
        æ”¶é¤…
      </label>

      <input id="note" type="text" placeholder="å‚™è¨» (é¸å¡«)" class="w-full p-2 border rounded"/>
      <div class="flex gap-2">
        <button id="addBtn" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">æ–°å¢ç´€éŒ„</button>
        <button id="exportBtn" class="flex-1 bg-green-500 text-white p-2 rounded hover:bg-green-600">åŒ¯å‡º Excel</button>
      </div>
    </div>

    <!-- ç¸½é‡‘é¡ -->
    <div class="bg-white p-3 rounded shadow text-right text-xl font-bold">
      ç¸½é‡‘é¡ï¼š<span id="totalAmount">0</span> å…ƒ
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded-2xl shadow overflow-hidden">
        <thead class="bg-blue-100">
          <tr>
            <th class="text-left p-3">ç·¨è™Ÿ</th>
            <th class="text-left p-3">å§“å</th>
            <th class="text-left p-3">é‡‘é¡</th>
            <th class="text-left p-3">åˆ†é¡</th>
            <th class="text-left p-3">å‚™è¨»</th>
            <th class="p-3">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="recordTable" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </div>

  <script>
  // Google Apps Script API ç«¯é»
  const API_URL = 'https://script.google.com/macros/s/AKfycbzf9_L7ezUi_AY9esJdXpY62RIxa1LCtUj_XF4g-TVQWZP9PK9isf59CubEICDr8Ezc/exec';
  const STORAGE_KEY = 'giftRecords';         // å·²åŒæ­¥/å…¨éƒ¨è³‡æ–™
  const PENDING_KEY = 'pendingGiftRecords';  // å°šæœªåŒæ­¥çš„æœ¬åœ°è³‡æ–™

  const addBtn = document.getElementById('addBtn');
  const exportBtn = document.getElementById('exportBtn');
  const recordTable = document.getElementById('recordTable');
  const amountInput = document.getElementById('amount');
  const totalAmountEl = document.getElementById('totalAmount');
  const categoryInput = document.getElementById('category');
  const receivedCakeInput = document.getElementById('receivedCake');

  // å–å¾—æ‰€æœ‰ API è³‡æ–™
  async function fetchApiRecords() {
    try {
      const res = await fetch(API_URL);
      const result = await res.json();
      if (result.success) return result.data.map(r => ({
        name: r['å§“å'],
        amount: r['é‡‘é¡'],
        note: r['å‚™è¨»'],
        category: r['åˆ†é¡'],
        receivedCake: r['æ”¶é¤…'] === 'å·²æ”¶'
      }));
      else return [];
    } catch (e) {
      return [];
    }
  }

  // å–å¾— localStorage å°šæœªåŒæ­¥è³‡æ–™
  function getPendingRecords() {
    return JSON.parse(localStorage.getItem(PENDING_KEY) || '[]');
  }

  // å­˜å…¥ localStorage pending
  function addPendingRecord(record) {
    const arr = getPendingRecords();
    arr.push(record);
    localStorage.setItem(PENDING_KEY, JSON.stringify(arr));
  }

  // å­˜å…¥ localStorage å…¨éƒ¨ï¼ˆå·²åŒæ­¥è³‡æ–™ï¼‰
  function setSyncedRecords(records) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }
  function getSyncedRecords() {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  }

  // åˆä½µé¡¯ç¤ºï¼ˆAPIå·²åŒæ­¥ + æœ¬åœ°å°šæœªåŒæ­¥ï¼‰
  async function renderTable() {
    const syncedRecords = getSyncedRecords();
    const pendingRecords = getPendingRecords();
    const allRecords = [...syncedRecords, ...pendingRecords];
    recordTable.innerHTML = '';
    let total = 0;
    allRecords.forEach((record, index) => {
      total += Number(record.amount) || 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-3">${index + 1}</td>
        <td class="p-3">${record.name}</td>
        <td class="p-3">${record.amount}</td>
        <td class="p-3">${record.category}</td>
        <td class="p-3">${record.note}</td>
        <td class="p-3 text-center">
          <label>
            <input type="checkbox" class="cake-checkbox" ${record.receivedCake ? 'checked' : ''}/> æ”¶é¤…
          </label>
          <button class="bg-yellow-400 text-white px-2 py-1 rounded ml-1">ä¿®æ”¹</button>
          <button class="bg-red-500 text-white px-2 py-1 rounded ml-1">åˆªé™¤</button>
          ${index >= syncedRecords.length ? '<span style="color:red">(å¾…åŒæ­¥)</span>' : ''}
        </td>
      `;

      // åˆªé™¤
      tr.querySelectorAll('button')[1].addEventListener('click', () => {
        if (index < syncedRecords.length) {
          alert('å·²åŒæ­¥è³‡æ–™ä¸å¯ç›´æ¥åˆªé™¤ï¼ˆå¦‚éœ€æ­¤åŠŸèƒ½è«‹æ“´å…… APIï¼‰');
          return;
        }
        pendingRecords.splice(index - syncedRecords.length, 1);
        localStorage.setItem(PENDING_KEY, JSON.stringify(pendingRecords));
        renderTable();
      });

      // ä¿®æ”¹
      tr.querySelectorAll('button')[0].addEventListener('click', () => {
        document.getElementById('name').value = record.name;
        amountInput.value = record.amount;
        document.getElementById('note').value = record.note;
        categoryInput.value = record.category;
        receivedCakeInput.checked = record.receivedCake;
        // åˆªé™¤åŸæœ¬ç´€éŒ„ï¼ŒæŒ‰æ–°å¢å³å¯è¦†è“‹
        if (index < syncedRecords.length) {
          alert('å·²åŒæ­¥è³‡æ–™ä¸å¯ç›´æ¥ä¿®æ”¹ï¼ˆå¦‚éœ€æ­¤åŠŸèƒ½è«‹æ“´å…… APIï¼‰');
          return;
        }
        pendingRecords.splice(index - syncedRecords.length, 1);
        localStorage.setItem(PENDING_KEY, JSON.stringify(pendingRecords));
        renderTable();
      });

      // æ”¶é¤…å‹¾é¸å³æ™‚æ›´æ–°
      tr.querySelector('.cake-checkbox').addEventListener('change', (e) => {
        record.receivedCake = e.target.checked;
        if (index < syncedRecords.length) {
          alert('å·²åŒæ­¥è³‡æ–™ä¸å¯ç›´æ¥ä¿®æ”¹ï¼ˆå¦‚éœ€æ­¤åŠŸèƒ½è«‹æ“´å…… APIï¼‰');
          return;
        }
        localStorage.setItem(PENDING_KEY, JSON.stringify(pendingRecords));
      });

      recordTable.appendChild(tr);
    });
    totalAmountEl.textContent = total;
  }

  // å¿«é€Ÿé‡‘é¡æŒ‰éˆ•
  document.querySelectorAll('.quick-amount').forEach(btn => {
    btn.addEventListener('click', () => amountInput.value = btn.textContent);
  });

  // æ–°å¢ç´€éŒ„ï¼ˆå…ˆå­˜ localStorage pendingï¼Œç«‹å³é¡¯ç¤ºï¼‰
  addBtn.addEventListener('click', () => {
    const name = document.getElementById('name').value.trim();
    const amount = amountInput.value.trim();
    const note = document.getElementById('note').value.trim();
    const category = categoryInput.value;
    const receivedCake = receivedCakeInput.checked;
    if (!name || !amount) return alert('è«‹è¼¸å…¥å§“åå’Œé‡‘é¡');
    addPendingRecord({ name, amount, note, category, receivedCake });
    renderTable();
    document.getElementById('name').value = '';
    amountInput.value = '';
    document.getElementById('note').value = '';
    receivedCakeInput.checked = false;
  });

  // åŒ¯å‡º Excelï¼ˆå…¨éƒ¨è³‡æ–™ï¼šAPIå·²åŒæ­¥+pendingï¼‰
  exportBtn.addEventListener('click', () => {
    const records = [...getSyncedRecords(), ...getPendingRecords()];
    if (records.length === 0) return alert('æ²’æœ‰ç´€éŒ„å¯åŒ¯å‡º');
    let csvContent = "\uFEFF"; // BOM
    csvContent += "ç·¨è™Ÿ,å§“å,é‡‘é¡,åˆ†é¡,å‚™è¨»,æ”¶é¤…\n";
    records.forEach((r, i) => {
      csvContent += `${i + 1},${r.name},${r.amount},${r.category},${r.note},${r.receivedCake ? 'å·²æ”¶' : 'æœªæ”¶'}\n`;
    });
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `ç¦®é‡‘ç°¿_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  });

  // åŒæ­¥ pending åˆ° APIï¼ˆæ¯ 10 ç§’è‡ªå‹•å˜—è©¦ï¼‰
  async function syncPendingToApi() {
    let pending = getPendingRecords();
    if (!pending.length) return;
    let syncedRecords = getSyncedRecords();
    for (let i = 0; i < pending.length; ) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(pending[i]),
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await res.json();
        if (result.success) {
          // åŒæ­¥æˆåŠŸï¼ŒåŠ å…¥å·²åŒæ­¥ç´€éŒ„ï¼Œç§»é™¤ pending
          syncedRecords.push(pending[i]);
          pending.splice(i, 1);
          setSyncedRecords(syncedRecords);
        } else {
          i++;
        }
      } catch (e) {
        i++;
      }
    }
    localStorage.setItem(PENDING_KEY, JSON.stringify(pending));
    renderTable();
  }
  setInterval(syncPendingToApi, 10000);

  // é¦–æ¬¡å•Ÿå‹•æ™‚ï¼Œå…ˆè¼‰å…¥ API ç´€éŒ„åˆ° localStorage
  async function init() {
    const apiRecords = await fetchApiRecords();
    setSyncedRecords(apiRecords);
    renderTable();
  }
  init();
</script>
</body>
</html>
